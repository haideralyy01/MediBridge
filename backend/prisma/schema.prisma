// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS - Base authentication table
// ============================================
model User {
  id             Int       @id @default(autoincrement())
  googleId       String?   @unique @map("google_id") @db.VarChar(255)
  email          String    @unique @db.VarChar(255)
  name           String?   @db.VarChar(255)
  role           String?   @default("patient") @db.VarChar(50)
  profilePicture String?   @map("profile_picture") @db.VarChar(500)
  lastLogin      DateTime? @map("last_login") @db.Timestamp(6)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  doctor           Doctor?
  healthRecords    HealthRecord[]
  medicines        Medicine[]
  testRecordsAsUser   TestRecord[] @relation("TestRecordUser")
  testRecordsAsDoctor TestRecord[] @relation("TestRecordDoctor")
  analytics        Analytics[]
  auditLogs        AuditLog[]
  visitsAsPatient  DoctorVisit[] @relation("VisitPatient")
  visitsAsDoctor   DoctorVisit[] @relation("VisitDoctor")

  @@index([email], map: "idx_users_email")
  @@index([googleId], map: "idx_users_google_id")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

// ============================================
// DOCTORS - Doctor-specific profile data
// ============================================
model Doctor {
  id                Int       @id @default(autoincrement())
  userId            Int?      @unique @map("user_id")
  licenseNumber     String?   @unique @map("license_number") @db.VarChar(255)
  specialization    String?   @db.VarChar(255)
  hospital          String?   @db.VarChar(255)
  yearsOfExperience Int?      @map("years_of_experience")
  experienceYears   Int?      @map("experience_years")
  address           String?
  phone             String?   @db.VarChar(50)
  website           String?   @db.VarChar(255)
  description       String?
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_doctors_user_unique")
  @@index([licenseNumber], map: "idx_doctors_license_unique")
  @@map("doctors")
}

// ============================================
// HEALTH RECORDS - Patient medical records
// ============================================
model HealthRecord {
  id                 Int       @id @default(autoincrement())
  userId             Int?      @map("user_id")
  patientId          String?   @map("patient_id") @db.VarChar(100)
  recordType         String    @default("general") @map("record_type") @db.VarChar(100)
  title              String    @default("Untitled") @db.VarChar(255)
  description        String?
  
  // ICD-11 Classification
  icd11Code          String?   @map("icd11_code") @db.VarChar(50)
  icd11Title         String?   @map("icd11_title") @db.VarChar(255)
  
  // Clinical Data
  diagnosis          String?
  symptoms           String[]
  medications        Json?
  testResults        Json?     @map("test_results")
  attachments        Json?
  
  // Visit Info
  doctorName         String?   @map("doctor_name") @db.VarChar(255)
  hospitalName       String?   @map("hospital_name") @db.VarChar(255)
  visitDate          DateTime? @map("visit_date") @db.Date
  severity           String?   @db.VarChar(50)
  
  // Legacy fields
  bloodType          String?   @map("blood_type") @db.VarChar(10)
  allergies          String?
  medicalHistory     String?   @map("medical_history")
  
  // Status
  status             String?   @default("active") @db.VarChar(50)
  verificationStatus String?   @default("pending") @map("verification_status") @db.VarChar(50)
  verificationData   Json?     @map("verification_data")
  
  createdAt          DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt          DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  user              User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  verificationLogs  VerificationLog[]

  @@index([userId], map: "idx_health_records_user_id")
  @@index([patientId], map: "idx_health_records_patient_id")
  @@index([recordType], map: "idx_health_records_type")
  @@index([status], map: "idx_health_records_status")
  @@index([icd11Code], map: "idx_health_records_icd11")
  @@map("health_records")
}

// ============================================
// MEDICINES - Prescribed medications
// ============================================
model Medicine {
  id             Int       @id @default(autoincrement())
  userId         Int?      @map("user_id")
  patientId      String?   @map("patient_id") @db.VarChar(100)
  medicineName   String    @map("medicine_name") @db.VarChar(255)
  medicationName String    @default("Unknown") @map("medication_name") @db.VarChar(255)
  dosage         String?   @db.VarChar(100)
  frequency      String?   @db.VarChar(100)
  prescribedBy   String?   @map("prescribed_by") @db.VarChar(255)
  startDate      DateTime? @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  notes          String?
  status         String?   @default("active") @db.VarChar(50)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_medicines_user_id")
  @@index([patientId], map: "idx_medicines_patient_id")
  @@index([status], map: "idx_medicines_status")
  @@map("medicines")
}

// ============================================
// TEST RECORDS - Medical tests and results
// ============================================
model TestRecord {
  id           Int       @id @default(autoincrement())
  userId       Int?      @map("user_id")
  patientId    String?   @map("patient_id") @db.VarChar(100)
  doctorId     Int?      @map("doctor_id")
  testName     String    @map("test_name") @db.VarChar(255)
  testType     String?   @map("test_type") @db.VarChar(100)
  result       String?   @db.VarChar(500)
  normalRange  String?   @map("normal_range") @db.VarChar(100)
  testDate     DateTime? @map("test_date") @db.Date
  frequency    String?   @db.VarChar(100)
  reason       String?
  instructions String?
  notes        String?
  status       String?   @default("scheduled") @db.VarChar(50)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user   User? @relation("TestRecordUser", fields: [userId], references: [id], onDelete: Cascade)
  doctor User? @relation("TestRecordDoctor", fields: [doctorId], references: [id], onDelete: NoAction)

  @@index([userId], map: "idx_test_records_user_id")
  @@index([patientId], map: "idx_test_records_patient_id")
  @@index([status], map: "idx_test_records_status")
  @@map("test_records")
}

// ============================================
// DOCTOR VISITS - Appointment/visit records
// ============================================
model DoctorVisit {
  id             Int       @id @default(autoincrement())
  patientId      Int?      @map("patient_id")
  doctorId       Int?      @map("doctor_id")
  visitDate      DateTime  @map("visit_date") @db.Timestamp(6)
  reasonForVisit String?   @map("reason_for_visit")
  diagnosis      String?
  treatmentPlan  String?   @map("treatment_plan")
  hospital       String?   @db.VarChar(255)
  status         String?   @db.VarChar(50)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  patient User? @relation("VisitPatient", fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User? @relation("VisitDoctor", fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("doctor_visits")
}

// ============================================
// ANALYTICS - Usage metrics and statistics
// ============================================
model Analytics {
  id           Int       @id @default(autoincrement())
  userId       Int?      @map("user_id")
  metricType   String    @map("metric_type") @db.VarChar(100)
  metricValue  Json      @map("metric_value")
  dateRecorded DateTime? @default(dbgenerated("CURRENT_DATE")) @map("date_recorded") @db.Date
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_analytics_user_id")
  @@index([metricType], map: "idx_analytics_type")
  @@index([dateRecorded], map: "idx_analytics_date")
  @@map("analytics")
}

// ============================================
// AUDIT LOGS - System activity tracking
// ============================================
model AuditLog {
  id           Int       @id @default(autoincrement())
  userId       Int?      @map("user_id")
  action       String    @db.VarChar(255)
  resourceType String?   @map("resource_type") @db.VarChar(100)
  resourceId   Int?      @map("resource_id")
  details      Json?
  timestamp    DateTime? @default(now()) @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: NoAction)

  @@index([userId], map: "idx_audit_logs_user_id")
  @@index([action], map: "idx_audit_logs_action")
  @@index([timestamp], map: "idx_audit_logs_timestamp")
  @@map("audit_logs")
}

// ============================================
// VERIFICATION LOGS - Record verification tracking
// ============================================
model VerificationLog {
  id               Int       @id @default(autoincrement())
  recordId         Int?      @map("record_id")
  verificationType String    @map("verification_type") @db.VarChar(50)
  status           String    @db.VarChar(50)
  verificationData Json?     @map("verification_data")
  verifiedBy       String?   @map("verified_by") @db.VarChar(255)
  verifiedAt       DateTime? @default(now()) @map("verified_at") @db.Timestamp(6)
  notes            String?

  // Relations
  healthRecord HealthRecord? @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId], map: "idx_verification_logs_record_id")
  @@map("verification_logs")
}
